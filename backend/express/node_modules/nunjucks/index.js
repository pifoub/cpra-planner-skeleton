const fs = require('fs');
const path = require('path');

exports.configure = function(dir, _opts = {}) {
  const env = {
    filters: {},
    addFilter(name, fn) { this.filters[name] = fn; },
    render(template, context) {
      let tpl = fs.readFileSync(path.join(dir, template), 'utf8');
      tpl = tpl.replace(/\{%[^%]*%\}/g, '');
      return tpl.replace(/{{\s*([^}]+)\s*}}/g, (_m, expr) => {
        const parts = expr.split('|').map(p => p.trim());
        const pathExpr = parts[0];
        const filter = parts[1];
        let val = pathExpr.split('.').reduce((acc, key) => (acc ? acc[key] : ''), context);
        if (filter && env.filters[filter]) val = env.filters[filter](val);
        return val ?? '';
      });
    },
  };
  return env;
};
